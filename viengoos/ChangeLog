2007-12-04  Neal H. Walfield  <neal@gnu.org>

	Remove exception threads.  Replace with support for activations.
	* thread.h (THREAD_SLOTS): Bump to 3.
	(struct thread): Add field exception_page.  Remove fields
	have_exception and exception.
	(thread_exregs): Take additional arguments exception_page and
	exception_page_out.  Update users.
	(thread_raise_exception): New declaration.
	* thread.c (THREAD_VERSION): Define.
	(thread_init): Remove code related to the exception thread.
	(thread_commission): Likewise.
	(thread_decommission): Likewise.
	(thread_exregs): Likewise.  Take additional arguments
	EXCEPTION_PAGE and EXCEPTION_PAGE_OUT.  If CONTROL contains
	HURD_EXREGS_GET_REGS and EXCEPTION_PAGE_OUT is not NULL, return a
	capability to THREAD's exception page in *EXCEPTION_PAGE_OUT.  If
	CONTROL contains HURD_EXREGS_SET_EXCEPTION_PAGE, then set THREAD's
	exception page to EXCEPTION_PAGE.
	(thread_raise_exception): New function.
	* server.c (server_loop): Remove code related to handling the
	exception thread.  Call thread_raise_exception to propagate
	exception.  Reimplement the exception_collect method.  Update
	implementation of the thread_exregs method to support the new
	argument passing scheme.  Add support for setting and retrieving
	the exception page.
	(REPLYW): Only clear MSG here.
	* rm.h (exception_collect): Take an additional argument, the
	principal.
	* object.h (object_type): New function.

2007-12-01  Neal H. Walfield  <neal@gnu.org>

	* rm.h: Update to use new RPC stub generation interface.

2007-11-29  Neal H. Walfield  <neal@gnu.org>

	* as.c [! RM_INTERN] (as_lock): New declaration.
	(as_slot_ensure_full) [! RM_INTERN]: Take AS_LOCK.
	(as_insert) [! RM_INTERN]: Likewise.
	* cap-lookup.c (cap_lookup_rel) [! RM_INTERN]: Likewise.
	(object_lookup_rel) [! RM_INTERN]: Likewise.
	(slot_lookup_rel) [! RM_INTERN]: Likewise.

2007-11-29  Neal H. Walfield  <neal@gnu.org>

	* server.c (server_loop): Use exception_fault_send_marshal, not
	exception_fault_marshal.
	
2007-11-29  Neal H. Walfield  <neal@gnu.org>

	* server.c (OBJECT_): Just pass REQUIRE_WRITABLE on to CAP_.
	(server_loop): Save the capability that identifies the principal.
	Implement the RM_activity_properties method.
	* rm.h (rm_method_id_string): Handle the RM_activity_properties
	case.

2007-11-28  Neal H. Walfield  <neal@gnu.org>

	* activity.h (activity_allocate): Rename from this...
	(activity_create): ... to this.  Remove arguments caller, folio,
	indent, activity and control.  Add argument child.  Update users.
	* activity.c (activity_allocate): Rename from this...
	(activity_create): ... to this.  Remove arguments caller, folio,
	indent, activity and control.  Add argument child.  If CHILD is
	live, destroy it first.  Correctly add CHILD to PARENT's children
	list.
	* activity.h (activity_destroy): Remove argument cap.  Update
	callers.
	* activity.c (activity_destroy): Remove argument cap.  Correctly
	destroy child activities and allocated folios.  Correctly unlink
	from parent.
	* server.c (CAP_): Remove argument writablep.  Add argument
	require_writable.  Fail if REQUIRE_WRITABLE is true, and the
	object is not writable.
	(OBJECT_): Likewise.
	(CAP): Remove argument writablep.  Add argument require_writable.
	Update callers.
	(OBJECT): Likewise.
	(server_loop): Add support for the activity_create method.
	* object.c (folio_free): Also update FOLIO->FOLIO_VERSION.
	(folio_object_alloc): Check if the object is a
	cap_activity_control, not a cap_activity.
	(folio_reparent): Correctly link FOLIO to PARENT.
	* t-as.c (test): Don't create a cap_activity object but a
	cap_activity_control object.
	* viengoos.c (system_task_load): Likewise.
	* cap.c (cap_to_object): Use cap_types_compatible when asserting
	that the capability's type and the object's type are identical.
	* thread.c (thread_exregs): Use cap_types_compatible when checking
	whether the thread has a valid activity object.
	* rm.h: Include <hurd/activity.h>.
	(rm_method_id_string): Handle the RM_activity_create case.

2007-11-28  Neal H. Walfield  <neal@gnu.org>

	* cap-lookup.c (lookup): Use cap_types_compatible to determine
	whether two types are compatible.

2007-11-27  Neal H. Walfield  <neal@gnu.org>

	* thread.c (thread_commission): After creating the exception
	thread, stop it cancelling any pending IPC.

2007-11-27  Neal H. Walfield  <neal@gnu.org>

	* server.c (server_loop): Add improve debugging output.

2007-11-23  Neal H. Walfield  <neal@gnu.org>

	* thread.h (thread_exregs): Take two additional arguments, a
	cap_addr_trans structure and a corresponding flags.  Update users.
	* thread.c (thread_commission): Don't start thread THREAD.
	(control_to_string): New function.
	(thread_exregs): Take two additional arguments, a cap_addr_trans
	structure and a corresponding flags.  Use them when copying a
	supplied capability into the address space slot of the thread.
	Support the HURD_EXREGS_EXCEPTION_THREAD flag.  Improve error
	detection and debugging out.
	* server.c (server_loop): Let a void address for the activity slot
	imply the caller's current activity.  Take two additional
	arguments, a cap_addr_trans structure and a corresponding flags
	argument.  Pass them to thread_exregs.
	* viengoos.c (system_task_load): Set THREAD_ACTIVITY.  Don't call
	thread_commission.  Instead, call thread_exregs.

2007-11-23  Neal H. Walfield  <neal@gnu.org>

	* cap-lookup.c (lookup): Improving debugging output for when we
	expect an address translation unit but don't find one.

2007-11-22  Neal H. Walfield  <neal@gnu.org>

	* thread.h (struct thread): Add fields efalgs, user_handle and
	init.
	(thread_create_in): Rename from this...
	(thread_init): ... to this.  Remove the activity argument.
	Update all users.
	(thread_create): Remove declaration.
	(thread_destroy): Rename from this...
	(thread_deinit): ... to this.  Update all users.
	(thread_send_sp_ip): Remove declaration.
	(thread_exregs): New declaration.
	* thread.c: Include <hurd/thread.h>.
	(thread_lookup): Add additional asserts.
	(thread_create_in): Rename from this...
	(thread_init): ... to this.  Remove the activity argument.  Don't
	set THREAD->ACTIVITY.  Set THREAD->INIT to true.
	(thread_create): Remove function.
	(thread_destroy): Rename from this...
	(thread_deinit): ... to this.  Correctly calculate the bit to
	deallocate.  Fix assert.  Set THREAD->INIT to false.
	(thread_commission): If THREAD->INIT is false, first call
	thread_init.  Correctly calculate the thread ids to initialize.
	(thread_send_sp_ip): Remove function.
	(thread_exregs): New function.
	* rm.h (RPC_STUB_PREFIX): Include <hurd/thread.h>.
	(rm_method_id_string): Support RM_thread_exregs.
	(THREAD_ASPACE_SLOT, THREAD_ACTIVITY_SLOT): Move from...
	* ../hurd/thread.h: ... to this new file.
	* server.c: Include <hurd/thread.h>.
	(server_loop): Implement the thread_exregs RPC.
	* viengoos.c (system_task_load): Set THREAD->ACTIVITY to a
	capability designating ROOT_ACTIVITY.
	
2007-11-22  Neal H. Walfield  <neal@gnu.org>

	* activity.c (activity_destroy): Don't call OBJECT_FREE.
	* thread.c (thread_destroy): Likewise.

2007-11-22  Neal H. Walfield  <neal@gnu.org>

	* cap-lookup.c (lookup) [!RM_INTERN]: Set ROOT to the shadow slot
	when indexing a folio, not &FAKE_ROOT.

2007-11-22  Neal H. Walfield  <neal@gnu.org>

	* rm.h (CAP_COPY_COPY_SUBPAGE): Rename from this...
	(CAP_COPY_COPY_ADDR_TRANS_SUBPAGE): ... to this.  Update all users.
	(CAP_COPY_COPY_GUARD): Rename from this...
	(CAP_COPY_COPY_ADDR_TRANS_GUARD): ... to this.  Update all users.
	(CAP_COPY_COPY_SOURCE_GUARD): New constant.

2007-11-19  Neal H. Walfield  <neal@gnu.org>

	* thread.h (struct thread): Add fields have_exception and
	exception.
	(UTCB_AREA_SIZE): Provide space for two UTCBs.
	* thread.c: Include <hurd/exceptions.h>.
	(thread_create_in): For each thread that we allocate, allocate two
	consecutive l4 thread ids.
	(thread_commission): Initialize the main thread and the exception
	thread.
	(thread_decommission): Destroy both the main thread and the
	exception thread.

	* rm.h: Add RM_exception_collect.
	(rm_method_id_string): Handle RM_exception_collect.
	(exception_collect): New RPC method.
	* server.c: Include <hurd/exceptions.h>.
	(server_loop): If FROM is the exception thread, look up the thread
	object using the main thread id.  Propagate any fault to the
	exception thread.  If not immediately successful, save the message
	in THREAD->EXCEPTION and set THREAD->HAVE_EXCEPTION.  Implement
	the exception_collect method.

	(DEBUG): Also print the method number.

2007-11-19  Neal H. Walfield  <neal@gnu.org>

	* rm.h (RPC_STUB_PREFIX): Define.
	(RPC_ID_PREFIX): Likewise.
	(RPC_TARGET_NEED_ARG): Undefine.
	(RPC_TARGET): Define.
	#include <hurd/rpc.h>.
	(rm_putchar): Add declaration for __hurd_startup_data.
	(RPCX, RPCLOAD, RPCSTORE, RPC2, RPC3, RPC4, RPC5, RPC6, RPC7) 
	(RPC8, RPC9, RPC22, RPC32, RPC42, RPC52): Move from here...
	* ../hurd/rpc.h: ... to here.

2007-11-16  Neal H. Walfield  <neal@gnu.org>

	* viengoos/Makefile.am: New file based on ../wortel/Makefile.am.
	* viengoos/headers.m4: New file.
	* viengoos/config.m4: New file based on ../wortel/config.m4.

	* viengoos/viengoos.h: New file.
	* viengoos/viengoos.c: New file.
	* viengoos/activity.h: Likewise.
	* viengoos/activity.c: Likewise.
	* viengoos/as.h: Likewise.
	* viengoos/as.c: Likewise.
	* viengoos/cap-lookup.c: Likewise.
	* viengoos/cap.h: Likewise.
	* viengoos/cap.c: Likewise.
	* viengoos/thread.h: New file.
	* viengoos/thread.c: New file.
	* viengoos/object.h: New file.
	* viengoos/object.c: New file.
	* viengoos/rm.h: New file.
	* viengoos/server.c: New file.
	* viengoos/server.h: New file.

	* viengoos/zalloc.h: Copied from ../physmem.
	* viengoos/zalloc.c: Copied from ../physmem.
	Don't include "output.h".
	Include <hurd/stddef.h>.
	Change uses of min_page_size to PAGESIZE.
	* viengoos/memory.h: New file.
	* viengoos/memory.c: New file.
	* viengoos/sigma0.c: Copy from ../wortel.
	* viengoos/sigma0.h: Copy from ../wortel.
	Don't include "shutdown.h".
	Include <hurd/stddef.h>.

	* viengoos/bits.h: Likewise.

	* viengoos/panic.c: New file.
	* viengoos/debug.c: Likewise.
	* viengoos/debug.h: Likewise.

	* viengoos/boot-modules.h: Likewise.
	* viengoos/boot-modules.c: Likewise.
	* viengoos/elf.h: Copied from ../wortel.
	* viengoos/loader.c: New file based on ../wortel/loader.c.
	* viengoos/loader.h: New file.
	* viengoos/multiboot.h: Copied from Grub.

	* viengoos/mmap.c: New file based on ../physmem/mmap.c.
	* viengoos/malloc-wrap.c: New file based on ../physmem/malloc-wrap.c.
	* viengoos/malloc.c: Version 2.8.3 of Doug Lea's malloc.c.
	* viengoos/malloc.h: Version 2.8.3 of Doug Lea's malloc.h.

	* viengoos/ia32-cmain.c: New file based on ../wortel/ia32-cmain.c.
	* viengoos/ia32-crt0.S: Copied from ../wortel.
	(STACK_SIZE): Use a 16 page stack.
	* viengoos/ia32-output.c: Copied from ../wortel.
	* viengoos/ia32-shutdown.c: Likewise.

	* viengoos/output.h: New file based on ../wortel/output.h.
	Include <stdarg.h>.
	(cprintf): New definition.
	(output_debug): Don't define.
	(debug): Don't define.
	* viengoos/output.c: New file based on ../wortel/output.c.
	Don't include <stdlib.h>.
	(vprintf): New function.
	(printf): Implement in terms of vprintf.
	* viengoos/output-none.c: Copied from ../wortel.
	* viengoos/output-serial.c: Likewise.
	* viengoos/output-stdio.c: New file.
	* viengoos/output-vga.c: Copied from ../wortel.

	* viengoos/shutdown.h: New file based on ../wortel/shutdown.h.
	Don't include "output.h".
	(panic): Don't define.
	(shutdown): Rename from this...
	(shutdown_machine): ... to this.
	* viengoos/shutdown.c: New file based on ../wortel/shutdown.c.
	(reset) [_L4_TEST_ENVIRONMENT]: Call abort.
	(halt) [_L4_TEST_ENVIRONMENT]: Call abort.
	(shutdown): Rename from this...
	(shutdown_machine): ... to this.

	* viengoos/t-environment.h: New file based on
	../libl4/tests/environment.h.
	Protect from multiple inclusion.
	Include <hurd/stddef.h>.
	Include <string.h>.
	Include <l4/stubs.h>.
	(program_name): New declaration.
	(check_nr): Don't assume that val1 and val2 are _L4_word_t, use
	typeof instead.
	(main): Call output_init.
	* viengoos/t-as.c: New file.
